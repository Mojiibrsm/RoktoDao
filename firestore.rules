rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check for admin role
    function isAdmin() {
      return exists(/databases/$(database)/documents/donors/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/donors/$(request.auth.uid)).data.isAdmin == true;
    }

    // Donors collection rules
    match /donors/{userId} {
      // Admins can do anything
      allow read, write: if isAdmin();
      
      // Users can only read/update their own profile
      allow get, update: if request.auth.uid == userId;

      // New users can create their own profile document
      allow create: if request.auth.uid == userId;
    }
    
    match /donors/{document=**} {
      // Allow public queries for available donors (for search page)
      // Allow admins to list all donors
      allow list: if request.query.where.isAvailable == true || isAdmin();
    }

    // Requests collection rules
    match /requests/{requestId} {
      // Allow ANYONE to read requests (for homepage stats and requests page)
      allow read: if true;
      
      // Allow logged-in users or admins to create requests
      allow create: if request.auth != null || isAdmin();
      
      // Allow only admins or the user who created it to update
      allow update: if isAdmin() || resource.data.uid == request.auth.uid;
      
      // Allow only admins to delete requests
      allow delete: if isAdmin();
    }

    // Marquee Notices rules
    match /marquee-notices/{noticeId} {
      // Anyone can read notices
      allow read: if true;
      // Only admins can write/delete notices
      allow write: if isAdmin();
    }
    
    // Moderators collection rules
    match /moderators/{modId} {
        // Allow anyone to read team members
        allow read: if true;
        // Allow only admins to manage moderators
        allow write: if isAdmin();
    }
    
    // Blog posts collection rules
    match /blogs/{blogId} {
        // Allow anyone to read blog posts
        allow read: if true;
        // Allow only admins to create, update, or delete posts
        allow write: if isAdmin();
    }

    // Settings collection rules
    match /settings/global {
      // Allow anyone to read site settings (for homepage)
      allow get: if true;
      // Allow only admins to update settings
      allow write: if isAdmin();
    }

    // OTP Codes - Only backend (admin) can access
    match /otp_codes/{phone} {
      allow read, write: if false; // Should only be accessed by admin SDK
    }
    
    // Gallery - Anyone can view approved, only logged in can create, only admin can update/delete
    match /gallery/{imageId} {
        allow get: if resource.data.status == 'approved' || isAdmin();
        allow list: if request.query.where.status == 'approved' || isAdmin();
        allow create: if request.auth != null;
        allow update, delete: if isAdmin();
    }
    
    // Feedback - Only admin can access
     match /feedback/{feedbackId} {
      allow read, write: if isAdmin();
    }
    
    // SMS Logs - Only admin can access
    match /sms_logs/{logId} {
      allow read, write: if false; // Should only be accessed by admin SDK
    }
  }
}
