
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin role
    function isAdmin() {
      return exists(/databases/$(database)/documents/donors/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/donors/$(request.auth.uid)).data.isAdmin == true;
    }

    // Donors collection rules
    match /donors/{donorId} {
      // ANYONE can check for existing users during signup
      // ANYONE can list available donors for searching
      // ADMINS can list all donors
      allow list: if (request.query.keys().hasOnly(['phoneNumber'])) || 
                     (request.query.keys().hasOnly(['email'])) ||
                     (request.query.where.isAvailable == true) ||
                     isAdmin();
                     
      // ANYONE can create a donor profile (signup)
      allow create: if true;
      
      // LOGGED-IN users can read their own data
      // ADMINS can read any donor's data
      allow get: if request.auth.uid == donorId || isAdmin();
      
      // LOGGED-IN users can update their own data
      // ADMINS can update any donor's data
      allow update: if request.auth.uid == donorId || isAdmin();
      
      // ADMINS can delete donors
      allow delete: if isAdmin();
    }
    
    // Blood Requests collection rules
    match /requests/{requestId} {
      // ANYONE can see the list of requests
      allow list, get: if true;
      
      // ANYONE can create a new blood request
      allow create: if true;
      
      // LOGGED-IN users can respond to a request (update responders)
      // ADMINS can update any request
      allow update: if request.auth != null || isAdmin();

      // ADMINS can delete requests
      allow delete: if isAdmin();
    }

    // Blogs, Gallery, Marquee, Moderators, Settings can be read by anyone
    match /blogs/{blogId} {
      allow get: if true;
      allow list: if true;
      allow read, write: if isAdmin();
    }

    match /gallery/{imageId} {
      allow get: if true;
      allow list: if true;
      allow read, write: if isAdmin();
      allow create: if request.auth != null; // Logged-in users can upload
    }

    match /marquee-notices/{noticeId} {
      allow get: if true;
      allow list: if true;
      allow read, write: if isAdmin();
    }
    
    match /moderators/{modId} {
      allow get: if true;
      allow list: if true;
      allow read, write: if isAdmin();
    }

    match /settings/global {
      allow get: if true;
      allow read, write: if isAdmin();
    }

    // OTP codes can be created by anyone, but only read/deleted by the system (server-side admin)
    match /otp_codes/{phone} {
       allow read, create, update, delete: if true; // Managed by secure backend APIs
    }
    
    // Feedback can be created by anyone, but only managed by admins
    match /feedback/{feedbackId} {
      allow create: if true;
      allow read, write: if isAdmin();
    }

    // SMS logs are admin-only
    match /sms_logs/{logId} {
      allow read, write: if isAdmin();
    }
  }
}
