rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check for admin role
    function isAdmin() {
      return exists(/databases/$(database)/documents/donors/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/donors/$(request.auth.uid)).data.isAdmin == true;
    }

    match /donors/{donorId} {
      // Anyone can query for existing users during signup
      allow list: if request.query.keys().hasAny(['phoneNumber', 'email']) || request.query.where.isAvailable == true || isAdmin();
      
      // Anyone can create a new donor profile (signup)
      allow create: if true;
      
      // Only the authenticated user can read or update their own data, or an admin
      allow read, update: if request.auth.uid == donorId || isAdmin();
      
      // Only admins can delete donor profiles
      allow delete: if isAdmin();
    }
    
    match /requests/{requestId} {
      // Allow ANYONE to read requests (for homepage stats and requests page)
      allow read: if true;
      
      // Allow anyone to create a request
      allow create: if true;
      
      // Only logged-in users can update (e.g., respond), or admins
      allow update: if request.auth != null || isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    match /settings/{docId} {
      // Only allow access to the 'global' settings document
      allow get: if docId == 'global';
      // Allow only admins to write/update settings
      allow write: if isAdmin();
    }
    
    match /moderators/{moderatorId} {
      // Allow anyone to read moderators list (for team/about page)
      allow read: if true;
      // Allow only admins to create, update, or delete moderators
      allow write: if isAdmin();
    }

    match /blogs/{blogId} {
       // Allow anyone to read blog posts
      allow read: if true;
      // Allow only admins to write
      allow write: if isAdmin();
    }

    match /gallery/{imageId} {
      // Allow anyone to read APPROVED gallery images
      allow list: if request.query.where.status == 'approved' || isAdmin();
      allow get: if resource.data.status == 'approved' || isAdmin();
      
      // Allow only logged-in users to create (upload)
      allow create: if request.auth != null;

      // Allow only admins to update or delete
      allow update, delete: if isAdmin();
    }
    
    match /marquee-notices/{noticeId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /feedback/{feedbackId} {
      allow create: if true;
      allow read, write: if isAdmin();
    }

    match /otp_codes/{phone} {
      // For security, never allow reading of OTP codes.
      allow read: if false;
      // Allow anyone to create/update an OTP (for login/reset)
      allow write: if true;
    }
    
    match /sms_logs/{logId} {
      // Allow only admins to read or write SMS logs
      allow read, write: if isAdmin();
    }
    
  }
}
