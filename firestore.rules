rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isAdmin() {
      // Check if the user is authenticated and has an admin flag in their donor profile.
      return request.auth != null && 
             exists(/databases/$(database)/documents/donors/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/donors/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Publicly readable collections that don't require authentication.
    match /blogs/{document=**} {
      allow read;
      allow write: if isAdmin();
    }
    match /gallery/{document=**} {
      allow read, create; // Allow users to submit images
      allow update, delete: if isAdmin();
    }
    match /moderators/{document=**} {
      allow read;
      allow write: if isAdmin();
    }
    match /marquee-notices/{document=**} {
      allow read;
      allow write: if isAdmin();
    }
    match /requests/{document=**} {
      allow read, create; // Allow anyone to read or create blood requests
      allow update(status, responders, fulfilledBy): if request.auth != null; // Allow logged-in users to update status (e.g., respond)
      allow update, delete: if isAdmin(); // Admins have full update/delete access
    }
    
    // Settings collection for site-wide configuration.
    match /settings/stats {
        allow read; // Publicly readable stats like total donors
        allow write: if isAdmin(); // Only admins can update stats
    }
    match /settings/global {
        // Only admins can read/write global settings
        allow read, write: if isAdmin();
    }

    // Donors collection - granular access control.
    match /donors/{userId} {
      // ANYONE can create a donor profile during signup.
      allow create;
      
      // LOGGED-IN users can update or delete THEIR OWN profile.
      // ADMINS can update or delete ANY profile.
      allow update, delete: if request.auth.uid == userId || isAdmin();
      
      // ANYONE can read a profile if it's available OR pinned (for homepage).
      // ADMINS can read ANY profile.
      allow read, get: if (resource.data.isAvailable == true || resource.data.isPinned == true) || isAdmin();
    }
    
    // Rules for LISTING (querying) the donors collection.
    match /donors/{document=**} {
        // Allow public queries for available donors (for search page)
        // Allow admins to list all donors
        allow list: if request.query.where.isAvailable == true || isAdmin();
    }

    // OTP codes - NO client access. Server-side (admin SDK) only.
    match /otp_codes/{document=**} {
      allow read, write: if false;
    }
    
    // Feedback - NO client access. Server-side (admin SDK) only.
    match /feedback/{document=**} {
        allow read, write: if false;
    }
    
     // SMS Logs - NO client access. Server-side (admin SDK) only.
    match /sms_logs/{document=**} {
        allow read, write: if false;
    }
  }
}
