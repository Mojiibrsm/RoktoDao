rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuth() && get(/databases/$(database)/documents/donors/$(request.auth.uid)).data.isAdmin == true;
    }

    // Donors Collection
    match /donors/{userId} {
      allow read: if isAuth() && (isOwner(userId) || isAdmin());
      allow create: if isAuth() && isOwner(userId);
      allow update: if isAuth() && (isOwner(userId) || isAdmin());
      allow delete: if isAdmin();
    }
    
    match /donors/{document=**} {
      // Allow anyone to query the donors collection, but only if they are querying for available donors.
      // This is crucial for the public search page. Admins can list all.
      allow list: if request.query.where.isAvailable == true || isAdmin();
    }

    // Requests Collection
    match /requests/{requestId} {
      allow read: if true;
      allow create: if true;
      allow update(before, after): if isAdmin() || (isAuth() && before.uid == request.auth.uid);
      allow delete: if isAdmin();
    }
    
     match /requests/{document=**} {
       allow list: if true;
     }

    // Admin-only collections
    match /settings/{docId} {
        allow read, write: if isAdmin();
    }
    match /marquee-notices/{docId} {
        allow read: if true;
        allow write: if isAdmin();
    }
    match /blogs/{docId} {
        allow read: if true;
        allow write: if isAdmin();
    }
    match /moderators/{docId} {
        allow read: if true;
        allow write: if isAdmin();
    }
    match /gallery/{docId} {
        allow read: if resource.data.status == 'approved' || isAdmin(); 
        allow create: if isAuth() && request.resource.data.status == 'pending';
        allow write: if isAdmin();
    }
     match /gallery/{document=**} {
        allow list: if request.query.where.status == 'approved' || isAdmin();
     }

    // Feedback and SMS logs (Admin only)
     match /feedback/{docId} {
        allow read, write: if isAdmin();
     }
      match /sms_logs/{docId} {
        allow read, write: if isAdmin();
     }

    // OTP codes (Server/Admin SDK access only)
    match /otp_codes/{phone} {
      allow read, write: if false; 
    }
  }
}
